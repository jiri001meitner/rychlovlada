name: IndexNow notify on publish

on:
  workflow_run:
    workflows: ["Deploy Jekyll to GitHub Pages"]
    types:
      - completed

jobs:
  indexnow:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract changed URLs from git diff
        id: extract_urls
        run: |
          echo "Collecting changed URLs..."
          URLS=$(git diff --name-only HEAD^ HEAD | grep -E '\\.(md|html)$' || true)
          echo "Changed files:" "$URLS"
          URLS=$(echo "$URLS" | while read file; do
            if [[ "$file" == _posts/* ]]; then
              echo "$file" | sed -E 's#^_posts/([0-9]{4})-([0-9]{2})-([0-9]{2})-(.*)\\.(md|html)#https://rychlovlada.cz/\\1/\\2/\\3/\\4.html#'
            else
              clean_path=$(echo "$file" | sed -E 's#\\.md$#.html#')
              echo "https://rychlovlada.cz/$clean_path"
            fi
          done)
          echo "Prepared URLs for IndexNow:" "$URLS"
          echo "URL_LIST<<EOF" >> $GITHUB_ENV
          echo "$URLS" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Notify IndexNow
        if: env.URL_LIST != ''
        run: |
          INDEXNOW_KEY="5d8b838ff8a8410eebcfe2105c9f4c5d"
          JSON_BODY=$(printf '{"host":"rychlovlada.cz","key":"%s","urlList":[%s]}' "$INDEXNOW_KEY" "$(echo "$URL_LIST" | sed 's/^/\"/;s/$/\",/' | tr -d '\n' | sed 's/,$//')")
          echo "Sending payload: $JSON_BODY"
          curl -H "Content-Type: application/json" -d "$JSON_BODY" "https://api.indexnow.org/indexnow"
